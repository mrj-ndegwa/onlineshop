{% extends 'base.html'%}
{% load static %}
{%block title%}Home | Elphamatt {%endblock%}
{%block content%}
{% include  'topnav.html'%}


{%if messages%}
<div class="offset-lg-2 mt-1">
    <div class="col-lg-12">
        {% include 'messages.html' %}
    </div>
</div>
{%endif%}

<body style="background-color: #eee;">
   
    {% if not order.complete %}
    <div class="container">
        <div class="row p-2 mb-3">
            <div class="col-lg-4 col-md-10  p-2">
                {%if items%}
                <table class="table table-borderless">
                    <thead>
                        <tr>
                            <td colspan="4">
                                <h4><b>Order summary</b></h4>
                            </td>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items%}
                        <tr>
                            <td>
                                <div class="img-bx"><img src="{{item.product.image.url}}" alt="" width="50" height="50">
                                </div>
                            </td>
                            <td>{{item.product.product_name}}</td>
                            <td>Ksh{{item.get_total}}</td>
                            <td><b>X{{item.quantity}}</b></td>
                        </tr>
                        {%endfor%}
                        <tr>
                            <td colspan="4"> Total items<h4><b>{{order.get_cart_items}}</b></h4>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">Total Amount(Ksh)<h4><b>{{order.get_cart_total}}</b></h4></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col-lg-7 col-md-10 p-2">
                <div class="form card p-2">
                    <hr>
                    <form action="" method="post" style="margin:10px;" id="form">
                        {%csrf_token%}
                      
                        {% if customer%}

                        {%else%}
                        <h5 class="py-2"><b>Customer Information</b></h5>
                        <div class="row">
                            <div class="col-lg-5 mb-2">
                                <input type="text" name="first_name" placeholder="First name" id=""
                                    class="form-control">
                            </div>
                            <div class="col-lg-5 mb-2">
                                <input type="text" name="last_name" placeholder="Last Name" id="" class="form-control">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-5 mb-2">
                                <input type="email" name="email" placeholder="Enter you email" id=""
                                    class="form-control">
                            </div>
                        </div>
                        {%endif%}
                        <div class="row mt-2">
                            <h5 class="py-2"><b>Shipping Information</b></h5>
                            <div class="col-lg-5 mb-2">
                                <input type="text" name="county" id="" placeholder="county e.g Nairobi" class="form-control"required>
                            </div>
                            <div class="col-lg-5 mb-2">
                                <input type="text" name="location" placeholder="Location" id="" class="form-control" required>
                            </div>
                        </div>

                        <div class="row mt-2">
                            <div class="col-lg-5 mb-2">
                                <input type="text" name="state" id="" placeholder="state" class="form-control" required>
                            </div>
                            <div class="col-lg-5">
                                <input type="text" name="zipcode" placeholder="zipcode" id="" class="form-control" required>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-lg-5 mb-2">
                                <input type="phone" name="phone" id="" class="form-control" placeholder="+254.." required>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-lg-5">
                                <button type="submit" id="show-btn" class="btn btn-info">submit</i></button>
                            </div>
                            <!--  id="show-btn" -->
                         
                        </div>
                </div>
                <div id="pay-section" class="card mt-2 pay-section ">
                    <h4 class="p-2 "><b>Payment options</b></h4>
                    <div class="col-lg-4 p-2 mb-4">
                        <button class=" btn  btn-success" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Proceed with <img
                            src="/static/images/mpesa-icon.png" alt="" width="15%%"></button>
                    </div>
                </div>
                <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel" data-bs-backdrop="false"s>
                    <div class="offcanvas-header">
                      <h5 id="offcanvasRightLabel">Make payment to complete the order</h5>
                      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                    </div>
                    <div class="offcanvas-body">
                       
                      
                <div class="col-lg-12 col-md-12 p-3 card" >
                    <label for="phone_number" class="py-2"><b>Enter your M-pesa Number</b></label>
                    <p>Total Amount: <b>Ksh {{order.get_cart_total}}</b></p>
                    <input type="tel" name="m-pay-now" id="" class="form-control mt-2 "
                        placeholder="07..">
                    <button class="btn btn-success mt-3 btn-block mpesa-btn "type="button" id="pay-now-btn" >pay now <i class="fa fa-spinner fa-spin hidden " id="loading-icon"></i></button>
                    </form>
                </div>
                    </div>
                  </div>
    {%else%}
    {%if messages%}
<div class="offset-lg-2">
  <div class="col-lg-12">
    {% include 'messages.html' %}
  </div>
</div>
{%endif%}
    {%endif%}
    {%endif%}

</body>
<script>
    var user = "{{request.user}}"
    var total = "{{order.get_cart_total}}"
    console.log(total)
    var shipping = "{{order.shipping}}"
    document.getElementById('pay-section').classList.add('hidden')
    const buttonL = document.getElementById("pay-now-btn");
    const icon = document.getElementById("loading-icon");

    var form = document.getElementById('form')
    form.addEventListener('submit', function (e) {
        e.preventDefault()
        document.getElementById('show-btn').classList.add('hidden')
        console.log('form has been submitted')
        document.getElementById('pay-section').classList.remove('hidden')
    })

    document.getElementById('pay-now-btn').addEventListener('click', function (e) {
        buttonL.disabled = true; 
        icon.classList.remove("hidden");
        submitFormData()
    })

    function submitFormData() {
        userData = {
            'first_name': null,
            'last_name': null,
            'email': null,
            'total': total
        }
      
        shippingInfo = {
            'county': null,
            'state': null,
            'location': null,
            'zipcode': null,
            'phone': null,
        }
        shippingInfo.county = form.county.value
        shippingInfo.state = form.state.value
        shippingInfo.location = form.location.value
        shippingInfo.zipcode = form.zipcode.value
        shippingInfo.phone = form.phone.value

        if (user == 'AnonymousUser') {
            userData.first_name = form.first_name.value
            userData.last_name = form.last_name.value
            userData.email = form.email.value
        }
        fetch("/process_order/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({ 'form': userData, 'shipping': shippingInfo }),
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then((data) => {
                if (data.success) {
                    console.log('success', data)
                    alert('Transaction completed successfully')
                    cart = {}
                    document.cookie = "cart=" + JSON.stringify(cart) + ";domain=;path=/";
                    window.location.href = "{% url 'index' %}"
                } else {
                    console.error("Error:", data.error);
                    alert('Failed to complete transaction: ' + data.error)
                    buttonL.disabled = false;
                    icon.classList.add("hidden");
                }
            })
            .catch((error) => {
                console.error("Error:", error);
                alert('Failed to complete transaction')
                buttonL.disabled = false;
                icon.classList.add("hidden");
            });
    }
</script>


{%endblock%}